version: '3.8'

services:
  # Enterprise SaaS Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      # Application Config
      - APP_HTTP_HOST=0.0.0.0
      - APP_HTTP_PORT=8080

      # OAuth2 Configuration (replace with your values)
      - APP_OAUTH_PROVIDER=google
      - APP_OAUTH_CLIENT_ID=${GOOGLE_CLIENT_ID:-your-google-client-id}
      - APP_OAUTH_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-your-google-client-secret}
      - APP_OAUTH_REDIRECT_URL=${OAUTH_REDIRECT_URL:-http://localhost:8080/api/v1/auth/callback}

      # Multi-tenancy Configuration
      - APP_MULTITENANCY_STRATEGY=subdomain
      - APP_MULTITENANCY_DOMAIN=myapp.com

      # Pagination Configuration
      - APP_PAGINATION_DEFAULT_LIMIT=20
      - APP_PAGINATION_MAX_LIMIT=100

    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL Database (optional - for production setup)
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=unicorn
      - POSTGRES_PASSWORD=unicorn_secret
      - POSTGRES_DB=enterprise_saas
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U unicorn"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache (optional - for production setup)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Nginx Reverse Proxy (for subdomain routing)
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - app-network
    depends_on:
      - app
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
